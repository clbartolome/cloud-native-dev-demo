# CICD en

## CI - Tekton

- Clone locally the repository: `application-cicd`

- Create the tekton folders:
  ```
  |_application-cicd
    |_ tekton
      |_ config
      |_ pipelines
      |_ pipeline-runs
      |_ tasks
  ```

- Change project: `oc project demo-components`

- Create the persistence volume: `oc apply -f application-cicd/tekton/config/source-volume.yaml`

- Create pipeline: `oc apply -f application-cicd/tekton/pipelines/ci-pipeline.yaml`

- Create tasks:
  - Generate-tag: oc apply -f application-cicd/tekton/tasks/task-generate-tag.yaml

- Execute pipeline run: `oc create -f application-cicd/tekton/pipeline-runs/ci-run.yaml`


## CD - ArgoCD

- Add health checks: 
  ```sh
  oc project demo-dev

  # Configure liveness and readiness probes
  oc set probe deploy rest-example --liveness --get-url=http://:8080/q/health/live
  oc set probe deploy rest-example --readiness --get-url=http://:8080/q/health/ready

  # Review deployment
  oc describe deployment rest-example | grep health
  ```

- Create kustomize folders:
  ```
  |_application-cicd
    |_ deploy
      |_ base
      |_ overlays
        |_ stage
  ```

- Download deploy service and route
```sh
# Deployment
oc get deploy rest-example -o yaml > application-cicd/deploy/base/deployment.yaml

# Service
oc get svc rest-example -o yaml > application-cicd/deploy/base/service.yaml

# Route
oc get route rest-example -o yaml > application-cicd/deploy/base/route.yaml
```

- Cleanup deployment
  - Delete everything in `metadata` but `metadata.name`
  - Delete everything in `spec` but:
    - `spec.replicas`
    - `spec.template`
  - Delete everything in `spec.template` but:
    - `spec.replicas`
    - `spec.template`
  - Delete everything in `spec.template.spec.containers` but:
    - `spec.template.spec.containers.name`
    - `spec.template.spec.containers.image` (replace by `rest-example:version`)
    - `spec.template.spec.containers.imagePullPolicy`
    - `spec.template.spec.containers.livenessProbe`
    - `spec.template.spec.containers.ports` leave just 8080
    - `spec.template.spec.containers.readinessProbe` leave just 8080
  - Delete everything in `status`
  - Include envionment properties from configmap:
    ```yaml
    spec:
      template:
        spec: 
          containers:
          - name: rest-example
            envFrom: 
              - configMapRef:
                  name: rest-example-configuration
    ```

- Cleanup service
  - Delete everything in `metadata` but `metadata.name`
  - Delete everything in `spec` but `spec.ports` and leave just 8080
  - Delete everything in `status`

- Cleanup route
  - Delete everything in `metadata` but `metadata.name`
  - Delete everything in `spec` but:
    - `spec.to`
    - `spec.port`
  - Delete everything in `status`

- Create `application-cicd/deploy/base/kustomization.yaml`:
  ```yaml
  apiVersion: kustomize.config.k8s.io/v1beta1
  kind: Kustomization

  commonLabels:
    app.openshift.io/runtime: quarkus

  resources:
  - deployment.yaml
  - service.yaml
  - route.yaml
  ```

- Create `application-cicd/deploy/overlays/stage/kustomization.yaml`:
  ```yaml
  apiVersion: kustomize.config.k8s.io/v1beta1
  kind: Kustomization

  nameSuffix: -stage

  bases:
  - ../../base

  commonLabels:
    app: rest-example-stage

  configMapGenerator:
  - name: app-stage-configuration
    envs:
    - properties.env

  images:
  - name: rest-example
    newName: image-registry.openshift-image-registry.svc:5000/demo-dev/rest-example
    newTag: latest
  ```

  !! Change image newTag to the one generated by the CI pipeline

- Create `application-cicd/deploy/overlays/stage/properties.env`:
  ```
  APP_GREET="Hola, estamos en STAGE!"
  ```

- Test kustomization using: `kustomize build application-cicd/deploy/overlays/stage`

- Create ArgoCD application: `application-cicd/deploy/argo-app.yaml`:
  ```yaml
  apiVersion: argoproj.io/v1alpha1
  kind: Application
  metadata:
    name: rest-example-stage
  spec:
    project: default
    source:
      repoURL: @changeme
      targetRevision: master
      path: application-cicd/deploy/overlays/stage
    destination:
      server: https://kubernetes.default.svc
      namespace: demo-stage
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
  ```




