# 1. Development Environment Demo

During this demo we'll be using the folloing [deck of slides](TODO.com).

:loudspeaker: **Introduction to Development Environment Demo content - slides [x to x] TODO**

## 1.1. Clone existing repositories

Access Gitea isntance, user is `gitea` and the password is `openshift`:
```sh
# Get gitea url:
oc get route TODO
```

Clone `application-source` and `application-cicd` repositories locally.

## 1.2. Create Quarkus application

:loudspeaker: **Review Quarkus - slides [x to x] TODO**

Go to [code.quarkus.redhat.com](https://code.quarkus.redhat.com/) to generate your application initial code:

- Group: `com.redhat.cnd`
- Arctifact: `rest-example`
- Build Tool: `Maven`
- Version: `1.0.0-SNAPSHOT`
- Java Version: `11`
- Starter Code: `Yes`
- Extensions: `RESTEasy Jackson`

Extract and copy the downloaded code into `application-source` repo:

```sh
# Clone app
mkdir  ~/Desktop/demo/
cd ~/Desktop/demo/
git clone http://gitea-demo-components.%APPS_CLUSTER%/gitea/application-source.git

# Extract content
unzip ~/Downloads/rest-example.zip
cp -a rest-example/. application-source

# Push new code
cd application-source
git add . && git commit -m "Generated quarkus app." && git push
```

## 1.3. Configure CodeReady Workspaces

:loudspeaker: **Review CRW - slides [x to x] TODO**

Create a `devfile.yaml` file to create the application workspace (update @CHANGEME value with application repository url):

```yaml
apiVersion: 1.0.0
metadata:
  generateName: rest-example
projects:
  - name: rest-example
    source:
      type: git
      location: '@CHANGEME'
      branch: 'master'
components:
  - type: chePlugin
    id: redhat/quarkus-java11/latest
  - type: dockerimage
    alias: maven
    image: 'registry.redhat.io/codeready-workspaces/plugin-java11-rhel8:2.15'
    env:
      - name: JAVA_OPTS
        value: '-XX:MaxRAMPercentage=50.0 -XX:+UseParallelGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -Dsun.zip.disableMemoryMapping=true -Xms20m -Djava.security.egd=file:/dev/./urandom -Duser.home=/home/jboss'
      - name: MAVEN_OPTS
        value: $(JAVA_OPTS)
    memoryLimit: 512Mi
    mountSources: true
    volumes:
      - name: m2
        containerPath: /home/jboss/.m2
    endpoints:
      - name: quarkus-development-server
        port: 8080
      - attributes:
          path: /hello
        name: hello-greeting-endpoint
        port: 8080
      - attributes:
          path: /q/health
        name: health-endpoint
        port: 8080
      - attributes:
          public: 'false'
        name: debug
        port: 5005
      - attributes:
          public: 'false'
        name: tests
        port: 8081
commands:
  - name: 1. Package the application
    actions:
      - type: exec
        component: maven
        command: mvn package
        workdir: '${CHE_PROJECTS_ROOT}/rest-example'
  - name: 2. Run unit tests
    actions:
      - type: exec
        component: maven
        command: mvn test
        workdir: '${CHE_PROJECTS_ROOT}/rest-example'
  - name: 3. Start Quarkus in devmode (hot deploy + debug)
    actions:
      - type: exec
        component: maven
        command: 'mvn compile quarkus:dev -Dquarkus.http.host=0.0.0.0 -Dquarkus.live-reload.instrumentation=false -DAPP_GREET=holaaaa!'
        workdir: '${CHE_PROJECTS_ROOT}/rest-example'
  - name: Attach remote debugger
    actions:
      - type: vscode-launch
        referenceContent: |
          {
            "version": "0.2.0",
            "configurations": [
              {
                "type": "java",
                "request": "attach",
                "name": "Attach to Remote Quarkus App",
                "hostName": "localhost",
                "port": 5005
              }
            ]
          }
```

Add a link into README.md to start a workspace: 

```md
[![Create workspace](https://img.shields.io/badge/Red%20Hat-EE0000?style=for-the-badge&logo=redhat&logoColor=white)](@CODEREADY_URL/#@GITREPO/gitea/application-source/raw/branch/master/devfile.yaml)
```

:white_check_mark: Commit changes and then open the link from gitea:

```sh 
git add . && git commit -m "Included CRW devfile and link." && git push`
```

While the workspace is being created, review the 'devfile.yaml' and the CRW console.

## 1.4. Include Service layer and some delays

Start development hot deployment task, meanwhile review application source code. Once the application is running execute CRW task `hello-greeting-endpoint`.

Create a service class:

```java
@ApplicationScoped
public class GreetingService {
  public String message(){

    String greet = "ey there!!";

    try{
      TimeUnit.SECONDS.sleep(2);
    }catch (InterruptedException e){
      System.out.println("Ignoring sleep error");
    }

    System.out.println("Greeting message: " + this.greet);
    return this.greet;
  }
}
```

Inject service in `GreetingResource` and include a delay:

```java
@Path("/hello")
public class GreetingResource {

  @Inject
  GreetingService greetingService;

  @GET
  @Produces(MediaType.TEXT_PLAIN)
  public String hello() {
    try{
      TimeUnit.SECONDS.sleep(1);
    } catch (InterruptedException exception) {
      System.out.println("Ignored sleep error");
    }
    return service.message();
  }
}
```

Test using CRW task `hello-greeting-endpoint`.

:white_check_mark: Commit changes on CRW.

## 1.5. Add an environment property

Add property in `application.properties` file: `application.greeting.message=${APP_GREET}`

Inject it in `GreetingService` and return property value in `message()` method:

```java
@ConfigProperty(name = "application.greeting.message") 
String message;

public String message(){
    ... 
    System.out.println("Greeting message: " + message);
    return message;
}
```

Test using CRW task `hello-greeting-endpoint`.

Fix Tests by creating file `application-source/src/test/resources/application.properties` with values `application.greeting.message=Hello RESTEasy`.

:white_check_mark: Commit changes on CRW.

## 1.6. Include health checks

:loudspeaker: **Review health checks - slides [x to x] TODO**

Add Quarkus extension:

```sh
mvn quarkus:add-extension -Dextensions="quarkus-smallrye-health"
```

Test with CRW task `hello-greeting-endpoint`. Also test manually /q/health/live`  and `/q/health/ready`.

:white_check_mark: Commit changes on CRW.

## 1.7. Include Opentracing

Add Quarkus extension:

```sh
mvn quarkus:add-extension -Dextensions="quarkus-smallrye-opentracing"
```

Add `@Traced`annotation in `GreetingService` and add the following properties in `application.properties`:

```
quarkus.jaeger.service-name=${JAEGER_SERVICE:rest-example-service}
quarkus.jaeger.sampler-type=const
quarkus.jaeger.sampler-param=1
quarkus.jaeger.endpoint=${JAEGER_COLLECTOR:}
```

:white_check_mark: Commit changes on CRW.

## 1.8. Deploy application into DEV

Close CRW, pull changes locally and run unit tests to validate everything is ok.

Deploy into dev environment manually (change @GITEA url):

```sh
# Deploy application
oc new-app --name=rest-example \
  openshift/ubi8-openjdk-11:1.3~@GITEA \
  -e APP_GREET="Hello from DEV" \
  -n demo-dev

# Follow build logs
oc logs -f bc/rest-example
```

:loudspeaker: ** While build is running review application resources - slides [x to x] TODO**

Once the build finish, expose Route and test: 
```sh
# Expose service
oc expose svc rest-example

# Get route
oc get route

# Test application
curl http://@URL/helo
```
